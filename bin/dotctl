#!/usr/bin/env python3

import os
import subprocess
import re
import argparse
from datetime import datetime

# Define dotfiles directory
DOTFILES_DIR = os.path.expanduser("~/.config/dotfiles")

def get_nvim_normal_color(kind: str):
    cmd = ["nvim", "--headless", "-c", "hi Normal | quit"]
    result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    output = result.stdout.strip() + result.stderr.strip()

    m = re.search(r"guibg=#[0-9A-Fa-f]{6}" if kind == "bg" else r"guifg=#[0-9A-Fa-f]{6}", output)
    return m.group(0).split("=")[1] if m else None

def update_tmux_conf(hexcode: str):
    tmux_conf_path = os.path.join(DOTFILES_DIR, "config/tmux/tmux.conf")
    with open(tmux_conf_path, "r") as f:
        lines = f.readlines()
    with open(tmux_conf_path, "w") as f:
        for line in lines:
            if line.strip().startswith("set -g background"):
                f.write(f"set -g background {hexcode}\n")
            else:
                f.write(line)

def update_alacritty_conf(kind: str, hexcode: str):
    alacritty_conf_path = os.path.join(DOTFILES_DIR, "config/alacritty/alacritty.toml")
    with open(alacritty_conf_path, "r") as f:
        lines = f.readlines()

    inside_colors_primary = False
    key = "background" if kind == "bg" else "foreground"
    
    with open(alacritty_conf_path, "w") as f:
        for line in lines:
            stripped = line.strip()
            if stripped == "[colors.primary]":
                inside_colors_primary = True
            elif inside_colors_primary and stripped.startswith("["):
                inside_colors_primary = False
            if inside_colors_primary and stripped.startswith(key):
                f.write(f'{key} = "{hexcode}"\n')
            else:
                f.write(line)

def get_current_timestamp():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def git_commit_and_push():
    timestamp = get_current_timestamp()
    commit_msg = f"Update: {timestamp}"
    subprocess.run(["git", "add", "."], check=True)
    subprocess.run(["git", "commit", "-m", commit_msg], check=True)
    subprocess.run(["git", "push"], check=True)
    print(f"Changes committed and pushed with message: '{commit_msg}'")

def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("command", choices=["update"], help="dotctl command")
    parser.add_argument("-u", "--update", choices=["bg", "fg"], help="update target")
    return parser.parse_args()

if __name__ == "__main__":
    args = parse_args()

    # Handle 'update' command
    if args.command == "update":
        if args.update == "bg":
            color = get_nvim_normal_color("bg")
            if color:
                update_tmux_conf(color)
                update_alacritty_conf(args.update, color)
                print("Background updated!")
            else:
                print("Failed to get Neovim background color")
        
        elif args.update == "fg":
            color = get_nvim_normal_color("fg")
            if color:
                update_alacritty_conf(args.update, color)
                print("Foreground updated!")
            else:
                print("Failed to get Neovim foreground color")
        
        # Commit and push after update
        git_commit_and_push()
