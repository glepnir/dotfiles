#!/usr/bin/env python3

import os
import subprocess
import re
import argparse

def get_nvim_normal_color(kind: str):
    """
    kind: "fg" or "bg"
    return: "#rrggbb" or None
    """
    cmd = ["nvim", "--headless", "-c", "hi Normal | quit"]
    result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    output = result.stdout.strip() + result.stderr.strip()

    if kind == "bg":
        m = re.search(r"guibg=#[0-9A-Fa-f]{6}", output)
    else:  # fg
        m = re.search(r"guifg=#[0-9A-Fa-f]{6}", output)

    if m:
        return m.group(0).split("=")[1]
    return None

def update_tmux_conf(hexcode: str):
    tmux_conf_path = os.path.expanduser("~/.config/dotfiles/config/tmux/tmux.conf")

    with open(tmux_conf_path, "r") as f:
        lines = f.readlines()

    with open(tmux_conf_path, "w") as f:
        for line in lines:
            if line.strip().startswith("set -g background"):
                _ = f.write(f"set -g background {hexcode}\n")
            else:
                _ = f.write(line)

def update_alacritty_conf(kind: str, hexcode: str):
    """
    kind: "bg" or "fg"
    """
    alacritty_conf_path = os.path.expanduser("~/.config/dotfiles/config/alacritty/alacritty.toml")

    with open(alacritty_conf_path, "r") as f:
        lines = f.readlines()

    inside_colors_primary = False

    key = "background" if kind == "bg" else "foreground"

    with open(alacritty_conf_path, "w") as f:
        for line in lines:
            stripped = line.strip()

            if stripped == "[colors.primary]":
                inside_colors_primary = True
                _ = f.write(line)
                continue

            # exiting [colors.primary]
            if inside_colors_primary and stripped.startswith("[") and stripped.endswith("]"):
                inside_colors_primary = False

            # replace foreground/background
            if inside_colors_primary and stripped.startswith(key):
                _ = f.write(f'{key} = "{hexcode}"\n')
            else:
                _ = f.write(line)

def parse_args():
    parser = argparse.ArgumentParser()
    _ = parser.add_argument("-u", "--update", help="update target", choices=["bg", "fg"])
    return parser.parse_args()

if __name__ == "__main__":
    args = parse_args()
    if args.update == "bg":
        bg = get_nvim_normal_color("bg")
        if bg:
            update_tmux_conf(bg)
            update_alacritty_conf(args.update, bg)
            print("background updated!")
        else:
            print("get neovim background color failed")

    elif args.update == "fg":
        fg = get_nvim_normal_color("fg")
        if fg:
            update_alacritty_conf(args.update, fg)
            print("foreground updated!")
        else:
            print("get neovim foreground color failed")
