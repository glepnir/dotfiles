#!/usr/bin/env python3

import os
import re
import argparse
import subprocess
from datetime import datetime

DOTFILES = os.path.expanduser("~/.config/dotfiles")
NVIM = os.path.expanduser("~/.config/nvim")
TMUX = os.path.join(DOTFILES, "config/tmux/tmux.conf")
ALACRITTY = os.path.join(DOTFILES, "config/alacritty/alacritty.toml")


def ts():
    return datetime.now().strftime("%Y%m%d-%H%M%S")


def git_push(path: str):
    status = subprocess.run(
        ["git", "status", "--porcelain"],
        cwd=path,
        capture_output=True,
        text=True,
        check=True,
    )
    if not status.stdout.strip():
        return
    _ = subprocess.run(["git", "add", "."], cwd=path, check=True)
    _ = subprocess.run(["git", "commit", "-m", ts()], cwd=path, check=True)
    _ = subprocess.run(["git", "push"], cwd=path, check=True)


def nvim_color(kind: str):
    p = subprocess.run(
        ["nvim", "--headless", "-c", "hi Normal | qa"],
        capture_output=True,
        text=True,
    )
    pat = r"guibg=#[0-9A-Fa-f]{6}" if kind == "bg" else r"guifg=#[0-9A-Fa-f]{6}"
    m = re.search(pat, p.stdout + p.stderr)
    return m.group(0).split("=")[1] if m else None


def update_tmux(bg: str) -> bool:
    with open(TMUX, "r+") as f:
        lines = f.readlines()
        for i, l in enumerate(lines):
            if l.strip().startswith("set -g background"):
                cur = l.split()[-1]
                if cur == bg:
                    return False
                lines[i] = f"set -g background {bg}\n"
                f.seek(0)
                f.writelines(lines)
                f.truncate()
                return True
    return False


def update_alacritty(kind: str, color: str) -> bool:
    key = "background" if kind == "bg" else "foreground"
    with open(ALACRITTY, "r+") as f:
        lines = f.readlines()
        inside = False
        for i, l in enumerate(lines):
            s = l.strip()
            if s == "[colors.primary]":
                inside = True
            elif inside and s.startswith("["):
                inside = False
            elif inside and s.startswith(key):
                cur = s.split("=")[1].strip().strip('"')
                if cur == color:
                    return False
                lines[i] = f'{key} = "{color}"\n'
                f.seek(0)
                f.writelines(lines)
                f.truncate()
                return True
    return False


def sync_colors(scope: str | None) -> bool:
    changed = False

    if scope in (None, "bg"):
        bg = nvim_color("bg")
        if bg:
            changed |= update_tmux(bg)
            changed |= update_alacritty("bg", bg)

    if scope in (None, "fg"):
        fg = nvim_color("fg")
        if fg:
            changed |= update_alacritty("fg", fg)

    return changed


def parse():
    p = argparse.ArgumentParser(prog="dotctl")
    sub = p.add_subparsers(dest="cmd", required=True)

    ps = sub.add_parser("sync", help="sync colors from nvim")
    _ = ps.add_argument("scope", nargs="?", choices=("fg", "bg"))

    psu = sub.add_parser("syncu", help="sync colors and push dotfiles")
    _ = psu.add_argument("scope", nargs="?", choices=("fg", "bg"))

    pu = sub.add_parser("update", help="git push configs")
    _ = pu.add_argument("target", nargs="?", choices=("nvim", "dotfiles"))

    return p.parse_args()


def main():
    a = parse()

    if a.cmd == "sync":
        sync_colors(a.scope)
        return

    if a.cmd == "syncu":
        if sync_colors(a.scope):
            git_push(DOTFILES)
        return

    if a.cmd == "update":
        if a.target == "nvim":
            git_push(NVIM)
        elif a.target == "dotfiles":
            git_push(DOTFILES)
        else:
            git_push(DOTFILES)
            git_push(NVIM)


if __name__ == "__main__":
    main()
