#!/usr/bin/env python3

import os
import subprocess
import re
import argparse

def get_nvim_normal_bg():
    cmd = ["nvim", "--headless", "-c", "hi Normal | quit"]
    result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    output = result.stdout.strip() + result.stderr.strip()
    m = re.search(r"guibg=#[0-9A-Fa-f]{6}", output)
    if m:
        return m.group(0).split("=")[1]
    return None

def update_tmux_conf(hexcode: str):
    tmux_conf_path = os.path.expanduser("~/.config/dotfiles/config/tmux/tmux.conf")

    with open(tmux_conf_path, "r") as f:
        lines = f.readlines()

    with open(tmux_conf_path, "w") as f:
        for line in lines:
            if line.strip().startswith("set -g background"):
                _ = f.write(f"set -g background {hexcode}\n")
            else:
                _ = f.write(line)

def update_alacritty_conf(hexcode: str):
    alacritty_conf_path = os.path.expanduser("~/.config/dotfiles/config/alacritty/alacritty.toml")

    with open(alacritty_conf_path, "r") as f:
        lines = f.readlines()

    inside_colors_primary = False

    with open(alacritty_conf_path, "w") as f:
        for line in lines:
            stripped = line.strip()
            if stripped == "[colors.primary]":
                inside_colors_primary = True
                _ = f.write(line)
                continue

            if inside_colors_primary and stripped.startswith("[") and stripped.endswith("]"):
                inside_colors_primary = False

            if inside_colors_primary and stripped.startswith("background"):
                _ = f.write(f'background = "{hexcode}"\n')
            else:
                _ = f.write(line)

def parse_args():
    parser = argparse.ArgumentParser()
    _ = parser.add_argument("-u", "--update", help="update target", choices=["bg"])
    return parser.parse_args()

if __name__ == "__main__":
    args = parse_args()
    if args.update == "bg":  # pyright: ignore[reportAny]
        bg = get_nvim_normal_bg()
        if bg is not None:
            update_tmux_conf(bg)
            update_alacritty_conf(bg)
            print("background updated!")
        else:
            print("get neovim background color failed")
