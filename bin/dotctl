#!/usr/bin/env python3
"""dotctl - Sync colors from Neovim to Alacritty/Tmux"""
import os
import re
import argparse
import subprocess
from datetime import datetime
from typing import cast

DOTFILES = os.path.expanduser("~/.config/dotfiles")
NVIM = os.path.expanduser("~/.config/nvim")
TMUX = os.path.join(DOTFILES, "config/tmux/tmux.conf")
ALACRITTY = os.path.join(DOTFILES, "config/alacritty/alacritty.toml")
GHOSTTY = os.path.join(DOTFILES, "config/ghostty/config")
TERMINAL_BLACK = "#0f0f0f"

def ts() -> str:
    return datetime.now().strftime("%Y%m%d-%H%M%S")


def git_push(path: str) -> None:
    status = subprocess.run(
        ["git", "status", "--porcelain"],
        cwd=path,
        capture_output=True,
        text=True,
        check=True,
    )
    if not status.stdout.strip():
        return
    _ = subprocess.run(["git", "add", "."], cwd=path, check=True)
    _ = subprocess.run(["git", "commit", "-m", ts()], cwd=path, check=True)
    _ = subprocess.run(["git", "push"], cwd=path, check=True)


def get_nvim_colors() -> dict[str, str]:
    """Extract all colors from Neovim via ColorOutPut command."""
    p = subprocess.run(
        ["nvim", "--headless", "-c", "ColorOutPut", "-c", "qa"],
        capture_output=True,
        text=True,
    )
    output = p.stdout + p.stderr
    colors: dict[str, str] = {}
    for line in output.splitlines():
        m = re.match(r"(\w+)\s*=\s*\"?#?([0-9A-Fa-f]{6})\"?", line)
        if m:
            colors[m.group(1)] = "#" + m.group(2)

    return colors


def update_tmux(bg: str) -> bool:
    """Update tmux background color."""
    if not os.path.exists(TMUX):
        return False

    with open(TMUX, "r+") as f:
        lines = f.readlines()
        changed = False
        for i, line in enumerate(lines):
            if line.strip().startswith("set -g background"):
                cur = line.split()[-1]
                if cur != bg:
                    lines[i] = f"set -g background {bg}\n"
                    changed = True
        if changed:
            _ = f.seek(0)
            f.writelines(lines)
            _ = f.truncate()
    return changed


def update_alacritty_primary(kind: str, color: str) -> bool:
    """Update primary colors in alacritty.toml."""
    if not os.path.exists(ALACRITTY):
        return False

    key = "background" if kind == "bg" else "foreground"
    changed = False

    with open(ALACRITTY, "r+") as f:
        lines = f.readlines()
        inside = False
        for i, line in enumerate(lines):
            s = line.strip()
            if s == "[colors.primary]":
                inside = True
            elif inside and s.startswith("["):
                inside = False
            elif inside and s.startswith(key):
                cur = s.split("=")[1].strip().strip('"')
                if cur != color:
                    lines[i] = f'{key} = "{color}"\n'
                    changed = True
        if changed:
            _ = f.seek(0)
            f.writelines(lines)
            _ = f.truncate()
    return changed


def update_alacritty_normal(colors: dict[str, str]) -> bool:
    """Update colors.normal section in alacritty.toml."""
    if not os.path.exists(ALACRITTY):
        return False

    with open(ALACRITTY, "r") as f:
        lines = f.readlines()

    changed = False
    inside_normal = False
    new_lines: list[str] = []

    for line in lines:
        stripped = line.strip()

        if stripped == "[colors.normal]":
            inside_normal = True
            new_lines.append(line)
            continue

        if inside_normal and stripped.startswith("[") and stripped != "[colors.normal]":
            inside_normal = False

        if inside_normal and "=" in stripped:
            key = stripped.split("=")[0].strip()
            if key in colors:
                current_val = stripped.split("=")[1].strip().strip('"')
                new_val = colors[key]
                if current_val != new_val:
                    indent = len(line) - len(line.lstrip())
                    new_lines.append(" " * indent + f'{key} = "{new_val}"\n')
                    changed = True
                    continue

        new_lines.append(line)

    if changed:
        with open(ALACRITTY, "w") as f:
            f.writelines(new_lines)

    return changed

def update_ghostty_primary(kind: str, color: str) -> bool:
    if not os.path.exists(GHOSTTY):
        return False

    key = "background" if kind == "bg" else "foreground"
    changed = False

    with open(GHOSTTY, "r+") as f:
        lines = f.readlines()
        for i, line in enumerate(lines):
            if line.strip().startswith(f"{key} ="):
                cur = line.split("=", 1)[1].strip().strip('"')
                if cur != color:
                    lines[i] = f'{key} = "{color}"\n'
                    changed = True

        if changed:
            _ = f.seek(0)
            f.writelines(lines)
            _ = f.truncate()

    return changed

def update_ghostty_palette(nvim_colors: dict[str, str]) -> bool:
    if not os.path.exists(GHOSTTY):
        return False

    required = ["red", "green", "yellow", "blue", "magenta", "cyan", "fg"]
    if any(k not in nvim_colors for k in required):
        return False

    palette_map: dict[int, str] = {
        0: TERMINAL_BLACK,
        1: nvim_colors["red"],
        2: nvim_colors["green"],
        3: nvim_colors["yellow"],
        4: nvim_colors["blue"],
        5: nvim_colors["magenta"],
        6: nvim_colors["cyan"],
        7: nvim_colors["fg"],       # white = fg
    }

    with open(GHOSTTY, "r") as f:
        lines = f.readlines()

    changed = False
    seen: set[int] = set()
    new_lines: list[str] = []

    for line in lines:
        m = re.match(r"\s*palette\s*=\s*(\d+)\s*=\s*(#[0-9A-Fa-f]{6})", line)
        if m:
            idx = int(m.group(1))
            if idx in palette_map:
                val = palette_map[idx]
                seen.add(idx)
                new_line = f"palette = {idx}={val}\n"
                if line != new_line:
                    new_lines.append(new_line)
                    changed = True
                else:
                    new_lines.append(line)
                continue

        new_lines.append(line)

    for idx, val in palette_map.items():
        if idx not in seen:
            new_lines.append(f"palette = {idx}={val}\n")
            changed = True

    if changed:
        with open(GHOSTTY, "w") as f:
            f.writelines(new_lines)

    return changed

def sync_colors() -> bool:
    """Sync all colors from Neovim to terminal configs."""
    changed = False
    nvim_colors = get_nvim_colors()

    # Sync bg/fg
    if "bg" in nvim_colors:
        changed |= update_tmux(nvim_colors["bg"])
        changed |= update_alacritty_primary("bg", nvim_colors["bg"])
        changed |= update_ghostty_primary("bg", nvim_colors["bg"])
    if "fg" in nvim_colors:
        changed |= update_alacritty_primary("fg", nvim_colors["fg"])
        changed |= update_ghostty_primary("fg", nvim_colors["fg"])

    # Sync normal colors (red, green, yellow, blue, magenta, cyan, white, black)
    normal_keys = ["red", "green", "yellow", "blue", "magenta", "cyan", "white", "black"]
    normal_colors = {k: v for k, v in nvim_colors.items() if k in normal_keys}
    if normal_colors:
        changed |= update_alacritty_normal(normal_colors)

    if GHOSTTY:
        changed |= update_ghostty_palette(nvim_colors)

    return changed


def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(prog="dotctl", description="Sync colors from Neovim")
    sub = p.add_subparsers(dest="cmd", required=True)

    _ = sub.add_parser("sync", help="sync colors from nvim")
    _ = sub.add_parser("syncu", help="sync colors and push dotfiles")

    pu = sub.add_parser("update", help="git push configs")
    _ = pu.add_argument("target", nargs="?", choices=["nvim", "dotfiles"])

    return p.parse_args()


def main() -> None:
    args = parse_args()
    cmd = cast(str, args.cmd)

    if cmd == "sync":
        changed = sync_colors()
        print("✓ Colors synced" if changed else "✓ Colors already in sync")

    elif cmd == "syncu":
        changed = sync_colors()
        if changed:
            git_push(DOTFILES)
        print("✓ Colors synced and pushed" if changed else "✓ Colors already in sync")

    elif cmd == "update":
        target = cast(str | None, args.target)
        if target == "nvim":
            git_push(NVIM)
        elif target == "dotfiles":
            git_push(DOTFILES)
        else:
            git_push(DOTFILES)
            git_push(NVIM)
        print("✓ Configs pushed")


if __name__ == "__main__":
    main()
